name: Android CI - Tests y Cobertura JaCoCo

on:
  pull_request:
    branches:
      # Dispara el CI/CD en PRs dirigidos a estas ramas
      - main
      - develop
      - 'feature/**' 

jobs:
  test_and_coverage:
    runs-on: macos-latest  # Se recomienda macos para un mejor rendimiento del emulador con KVM
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 1. Configuraci√≥n de Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      # 2. Permisos de Ejecuci√≥n para Gradle
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 3. üöÄ Ejecutar Emulador Android y Tests
      - name: Run Android Emulator and Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33 # Puedes ajustar el nivel de la API seg√∫n tus necesidades
          arch: x86_64 # Especificar arquitectura 64-bit para API 33
          disable-animations: true # Mejorar rendimiento del emulador
          # Configuraci√≥n para modo headless y renderizado por software
          emulator-options: "-no-window -no-snapshot -no-boot-anim -gpu swiftshader_indirect"
          ram-size: 2048M # Asignar m√°s memoria RAM
          disk-size: 2048M # Asignar m√°s espacio en disco
          script: ./gradlew clean jacocoTestReport

      # 4. VALIDA la Cobertura (0%)
      # Esta tarea valida la cobertura del c√≥digo ejecutado
      - name: Validate Coverage (0%)
        run: ./gradlew jacocoTestCoverageVerification

      # 5. Sube el reporte HTML como Artifact
      - name: Upload coverage report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-html-report
          path: app/build/reports/jacoco/jacocoTestReport/html
          retention-days: 7

      # 6. Mostrar Resumen de Cobertura en el Log
      - name: Display Coverage Summary
        run: |
          echo "üìä Verificando reportes de cobertura..."
          
          # Rutas posibles donde puede estar el reporte XML
          POSSIBLE_PATHS=(
            "app/build/reports/coverage/test/debug/report.xml"
            "app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml"
            "app/build/reports/coverage/debug/jacocoTestReport.xml"
            "app/build/reports/jacoco/testDebugUnitTestCoverage/testDebugUnitTestCoverage.xml"
            "app/build/reports/jacoco/jacocoTestReport.xml"
          )
          
          REPORT_FOUND=false
          for xml_path in "${POSSIBLE_PATHS[@]}"; do
            if [ -f "$xml_path" ]; then
              echo "‚úÖ Reporte encontrado en: $xml_path"
              REPORT_FOUND=true
              
              # Extraer cobertura de l√≠neas
              COVERAGE=$(grep -oP '(?<=<counter type="LINE" missed=")[0-9]+" covered="[0-9]+"' "$xml_path" | awk -F'"' '{missed+=$2; covered+=$4} END {if(covered+missed>0) print covered/(covered+missed)*100; else print 0}')
              COVERAGE=$(printf "%.2f" "$COVERAGE")
              
              echo "üìà Cobertura de l√≠neas: ${COVERAGE}%"
              if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
                echo "‚úÖ Cobertura cumple con el umbral m√≠nimo del 80%"
              else
                echo "‚ùå Cobertura por debajo del umbral m√≠nimo del 80%"
              fi
              break
            fi
          done
          
          if [ "$REPORT_FOUND" = false ]; then
            echo "‚ö†Ô∏è No se encontr√≥ reporte de cobertura en ninguna ubicaci√≥n esperada"
            echo "üìÅ Contenido del directorio de reportes:"
            find app/build/reports -name "*.xml" 2>/dev/null || echo "No se encontraron archivos XML"
          fi

      # 7. Publica el reporte de tests (JUnit XML/HTML)
      - name: Publish JUnit Test Report
        uses: mikepenz/action-junit-report@v4
        if: always() 
        with:
          report_paths: '**/build/test-results/testDebugUnitTest/*.xml'